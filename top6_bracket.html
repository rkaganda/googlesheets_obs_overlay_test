<!DOCTYPE html>
    <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Tournament Bracket</title>
            <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                display: flex;
                justify-content: space-around;
            }

            .bracket-container {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .bracket {
                display: flex;
                justify-content: center;
                gap: 40px;
            }

            .round {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }

            .matchup {
                width: 200px;
                padding: 10px;
                border: 1px solid #ccc;
                border-radius: 5px;
                background-color: #f9f9f9;
                text-align: center;
                margin-top: 10px;
            }

            .round:nth-child(even) .matchup {
                margin-left: 100px;
            }
        </style>
    </head>
    <body>
        <div class="bracket-container">
            <div class="bracket winners" id="winners-bracket">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="bracket losers" id="losers-bracket">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
        <script>
            const API_TOKEN = "1a29688c2b18f69ccc43ffae667c18c2";
            const TOURNAMENT_SLUG = "game-lab-mega-monthly-11-presented-by-plusframesgg";
            const EVENT_SLUG = "tournament/game-lab-mega-monthly-11-presented-by-plusframesgg/event/under-night-in-birth-ii-sys-celes";
    
            async function fetchEventID(tournamentSlug, eventSlug) {
                const query = `
                query TournamentQuery($slug: String!) {
                    tournament(slug: $slug) {
                        events {
                            id
                            slug
                        }
                    }
                }
                `;
                const variables = { slug: tournamentSlug };
                const response = await fetch("https://api.start.gg/gql/alpha", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${API_TOKEN}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ query, variables })
                });
                const data = await response.json();
                const events = data.data.tournament.events;
                const event = events.find(event => event.slug === eventSlug);
                return event ? event.id : null;
            }
    
            async function fetchAllMatches(eventId) {
                const query = `
                query EventSets($eventId: ID!) {
                    event(id: $eventId) {
                        sets(sortType: STANDARD) {
                            nodes {
                                id
                                round
                                displayScore
                                winnerId
                                wPlacement
                                lPlacement
                                completedAt
                                slots {
                                    entrant {
                                        name
                                    }
                                    standing {
                                        stats {
                                            score {
                                                value
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                `;
                const variables = {
                    eventId: eventId
                };
                const response = await fetch("https://api.start.gg/gql/alpha", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${API_TOKEN}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ query, variables })
                });
                const data = await response.json();
                const matchups = data.data.event.sets.nodes;
    
                // Log all matches to the console
                console.log("All Matches:", matchups);
    
                return matchups;
            }
    
            function determineMinMaxRounds(matchups) {
                let minRound = Infinity;
                let maxRound = -Infinity;
    
                matchups.forEach(matchup => {
                    const round = matchup.round;
                    if (round < minRound) minRound = round;
                    if (round > maxRound) maxRound = round;
                });
    
                return { minRound, maxRound };
            }
    
            function displayBrackets(matchups) {
                const winnersBracketDiv = document.getElementById('winners-bracket');
                const losersBracketDiv = document.getElementById('losers-bracket');
    
                // Determine the min and max rounds
                const { minRound, maxRound } = determineMinMaxRounds(matchups);
                console.log(`Min Round: ${minRound}, Max Round: ${maxRound}`);
    
                const winnersRounds = {
                    "Winners Semi-Final": [],
                    "Winners Final": [],
                    "Grand Final": []
                };
    
                const losersRounds = {
                    "Losers Quarter-Final": [],
                    "Losers Semi-Final": [],
                    "Losers Final": []
                };
    
                matchups.forEach(matchup => {
                    const round = matchup.round;
                    const player1 = matchup.slots[0].entrant ? matchup.slots[0].entrant.name : "TBD";
                    const player2 = matchup.slots[1].entrant ? matchup.slots[1].entrant.name : "TBD";
                    const score1 = matchup.slots[0].standing && matchup.slots[0].standing.stats.score ? matchup.slots[0].standing.stats.score.value : 0;
                    const score2 = matchup.slots[1].standing && matchup.slots[1].standing.stats.score ? matchup.slots[1].standing.stats.score.value : 0;
    
    
                    const matchupHtml = `
                        <div class="matchup">
                            ${player1} ${score1} - ${score2} ${player2}
                        </div>
                    `;
    
                    if (round > 0) {
                        // Winners Bracket
                        if (round === maxRound - 2) {
                            winnersRounds["Winners Semi-Final"].push(matchupHtml);
                            console.log(`Match ${matchup.id} fits into Winners Semi-Final: ${player1} vs ${player2}, Round ${round}`);
                        } else if (round === maxRound - 1) {
                            winnersRounds["Winners Final"].push(matchupHtml);
                            console.log(`Match ${matchup.id} fits into Winners Final: ${player1} vs ${player2}, Round ${round}`);
                        } else if (round === maxRound) {
                            winnersRounds["Grand Final"].push(matchupHtml);
                            console.log(`Match ${matchup.id} fits into Grand Final: ${player1} vs ${player2}, Round ${round}`);
                        } else {
                            console.log(`Match ${matchup.id} doesn't fit into any Winners bracket category: ${player1} vs ${player2}, Round ${round}`);
                        }
                    } else if (round < 0) {
                        // Losers Bracket
                        if (round === minRound + 2) {
                            losersRounds["Losers Quarter-Final"].push(matchupHtml);
                            console.log(`Match ${matchup.id} fits into Losers Quarter-Final: ${player1} vs ${player2}, Round ${round}`);
                        } else if (round === minRound + 1) {
                            losersRounds["Losers Semi-Final"].push(matchupHtml);
                            console.log(`Match ${matchup.id} fits into Losers Semi-Final: ${player1} vs ${player2}, Round ${round}`);
                        } else if (round === minRound) {
                            losersRounds["Losers Final"].push(matchupHtml);
                            console.log(`Match ${matchup.id} fits into Losers Final: ${player1} vs ${player2}, Round ${round}`);
                        } else {
                            console.log(`Match ${matchup.id} doesn't fit into any Losers bracket category: ${player1} vs ${player2}, Round ${round}`);
                        }
                    } else {
                        console.log(`Match ${matchup.id} doesn't fit into any recognized bracket: ${player1} vs ${player2}, Round ${round}`);
                    }
                });
    
                Object.keys(winnersRounds).forEach(round => {
                    const roundDiv = document.createElement('div');
                    roundDiv.className = 'round';
                    roundDiv.innerHTML = `<div class="round-title">${round}</div>` + winnersRounds[round].join('');
                    winnersBracketDiv.appendChild(roundDiv);
                });
    
                Object.keys(losersRounds).forEach(round => {
                    const roundDiv = document.createElement('div');
                    roundDiv.className = 'round';
                    roundDiv.innerHTML = `<div class="round-title">${round}</div>` + losersRounds[round].join('');
                    losersBracketDiv.appendChild(roundDiv);
                });
            }
    
            async function loadBrackets() {
                try {
                    const eventId = await fetchEventID(TOURNAMENT_SLUG, EVENT_SLUG);
                    if (eventId) {
                        const matchups = await fetchAllMatches(eventId);
                        displayBrackets(matchups);
                    } else {
                        console.error("Event not found");
                    }
                } catch (error) {
                    console.error("Error loading bracket:", error);
                }
            }
    
            // Load the brackets on page load
            loadBrackets();
        </script>
    </body>
</html>